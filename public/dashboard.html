<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background-color: #f9f9f9; }
    #dashboardContent { background-color: #fff; padding: 20px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
    h2 { text-align: center; }
    input[type="text"] { padding: 6px; margin-top: 4px; width: 100%; }
    button { padding: 6px 12px; margin-top: 10px; cursor: pointer; }
    #message { color: green; margin-top: 10px; }
    #notLoggedIn { text-align: center; color: red; }
    a { color: #007bff; text-decoration: none; }
  </style>
</head>
<body>
  <h2>Welcome to Your Dashboard</h2>

  <div id="dashboardContent" style="display: none;">
    <p><strong>Name:</strong> <span id="userName"></span></p>
    <p><strong>Wallet Balance:</strong> â‚¦<span id="wallet">0</span></p>
    <p><strong>Your Referral Code:</strong> <span id="referralCode">N/A</span></p>
    <p><strong>Your Referral Link:</strong><br />
      <input type="text" id="referralLink" readonly />
      <br /><button onclick="copyLink()">Copy</button>
    </p>
    <p><strong>Referred By:</strong> <span id="referredBy">N/A</span></p>
    <p><strong>Users You Referred:</strong> <span id="referralsCount">0</span></p>

    <button id="logoutBtn">Logout</button>
    <p id="message"></p>
  </div>

  <div id="notLoggedIn" style="display: none;">
    <p>You are not logged in. Please <a href="/login.html">login</a>.</p>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const dashboard = document.getElementById("dashboardContent");
    const notLoggedIn = document.getElementById("notLoggedIn");

    try {
      // Use /dashboard API which returns { user: { ... } }
      const res = await fetch("/dashboard");
      if (!res.ok) throw new Error("Unauthorized");

      const data = await res.json();
      const user = data.user;

      dashboard.style.display = "block";
      notLoggedIn.style.display = "none";

      document.getElementById("userName").innerText = user.name;
      document.getElementById("wallet").innerText = user.wallet?.toLocaleString() || "0";
      document.getElementById("referralCode").innerText = user.myReferralCode || "N/A";
      document.getElementById("referredBy").innerText = user.referredBy || "N/A";
      document.getElementById("referralsCount").innerText = user.referralsCount || 0;
      document.getElementById("referralLink").value = `${window.location.origin}/signup.html?ref=${user.myReferralCode}`;

    } catch {
      notLoggedIn.style.display = "block";
      dashboard.style.display = "none";
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await fetch("/logout");
      window.location.href = "/login.html";
    });
  });

  function copyLink() {
    const input = document.getElementById("referralLink");
    navigator.clipboard.writeText(input.value)
      .then(() => document.getElementById("message").innerText = "Referral link copied!")
      .catch(() => document.getElementById("message").innerText = "Failed to copy link.");
  }
  </script>
</body>
</html>
