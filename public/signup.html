app.post('/signup', async (req, res) => {
  try {
    const { name, email, password, referralCode, activationCode } = req.body;
    // Basic validation
    if (!name || !email || !password || !activationCode)
      return res.status(400).json({ message: 'Name, email, password, and activation code are required.' });
    if (!validator.isEmail(email))
      return res.status(400).json({ message: 'Invalid email format.' });
    if (password.length < 6)
      return res.status(400).json({ message: 'Password must be at least 6 characters.' });

    const users = loadUsers();
    if (users.find(u => u.email === email))
      return res.status(400).json({ message: 'User already exists' });

    // Activation code validation (this is the fixed part)
    const codes = loadActivationCodes();
    console.log('Loaded codes:', codes); // Debugging line, optional
    const codeObj = codes.find(c => c.code === activationCode && !c.used);
    console.log('Submitted code:', activationCode, 'Matched codeObj:', codeObj); // Debugging line, optional
    if (!codeObj)
      return res.status(400).json({ message: 'Invalid or already used activation code.' });

    // Mark the code as used
    codeObj.used = true;
    fs.writeFileSync(ACTIVATION_CODES_FILE, JSON.stringify(codes, null, 2));

    const hashedPassword = await bcrypt.hash(password, 10);
    const myReferralCode = Math.random().toString(36).substring(2, 8).toUpperCase();

    // Referral logic
    let referredBy = '';
    if (referralCode) {
      const refUser = users.find(u => u.myReferralCode === referralCode);
      if (refUser) {
        referredBy = referralCode;
        refUser.wallet = (refUser.wallet || 0) + 1000;
        saveUsers(users);
      }
    }

    const newUser = { name, email, password: hashedPassword, myReferralCode, referredBy, wallet: 0 };
    users.push(newUser);
    saveUsers(users);

    req.session.userEmail = email;
    res.json({ message: 'Signup successful' });
  } catch (err) {
    console.error('Signup error:', err);
    res.status(500).json({ message: 'Internal server error.' });
  }
});
